<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #staff {
      position: relative;
      height: 200px;
      width: 100%;
      background-color: #f0f0f0;
      overflow: hidden;
    }

    .line {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background-color: black;
    }

    #note {
      position: absolute;
      height: 20px;
      width: 20px;
      background-color: black;
      border-radius: 50%;
      cursor: pointer;
      left: 100px;
      transition: top 0.2s ease;
    }
  </style>
  <title>Music App</title>
</head>
<body>

<!-- 五線譜と音符を表示するための要素 -->
<div id="staff"></div>
<div id="note"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    class StaffClass {
      constructor() {
        this.staffElement = document.getElementById('staff');
        this.lines = [];
      }

      drawStaff() {
        for (let i = 0; i < 5; i++) {
          const line = document.createElement('div');
          line.className = 'line';
          line.style.top = `${40 + i * 20}px`;
          this.staffElement.appendChild(line);
          this.lines.push(40 + i * 20);
        }

        const lowerLimitLine = document.createElement('div');
        lowerLimitLine.className = 'line';
        lowerLimitLine.style.top = `${40 + 5 * 20}px`;
        lowerLimitLine.style.backgroundColor = 'transparent';
        this.staffElement.appendChild(lowerLimitLine);
      }
    }

    class NoteClass {
      constructor(position, lines) {
        this.noteElement = document.getElementById('note');
        if (!this.noteElement) {
          throw new Error("Element with id 'note' not found");
        }
        this.lines = lines;
        this.setPosition(position);
      }

      setPosition(position) {
        this.position = position;
        this.noteElement.style.top = `${position}px`;
      }

      moveNote(direction) {
        const step = 20;
        const minPosition = 40;
        const maxPosition = 40 + 5 * 20;

		console.log("ok")

        if (direction === 'up' && this.position > minPosition) {
			console.log("up")
          for (let i = 0; i < this.lines.length; i++) {
            if (this.position <= this.lines[i]) {
              this.position = this.lines[i];
              break;
            }
          }
        } else if (direction === 'down' && this.position < maxPosition) {
			console.log("down")
          for (let i = this.lines.length - 1; i >= 0; i--) {
            if (this.position + step >= this.lines[i]) {
              this.position = this.lines[i] - step;
              break;
            }
          }
        }
        this.setPosition(this.position);
      }

      stepMoveNote(direction) {
        const currentLineIndex = this.lines.findIndex(line => this.position <= line + 10 && this.position >= line - 10);

        if (direction === 'up' && currentLineIndex > 0) {
          this.position = this.lines[currentLineIndex - 1];
        } else if (direction === 'down' && currentLineIndex < this.lines.length - 1) {
          this.position = this.lines[currentLineIndex + 1] - 20;
        }

        this.setPosition(this.position);
      }
    }

    class AppClass {
      constructor() {
        this.staff = new StaffClass();
        this.note = new NoteClass(100, this.staff.lines);
        this.bindEvents();
      }

      bindEvents() {
        document.addEventListener('mousemove', (event) => this.handleCursorMovement(event));
      }

      handleCursorMovement(event) {
        const mouseY = event.clientY;
        const staffRect = this.staff.staffElement.getBoundingClientRect();

        if (mouseY >= staffRect.top && mouseY <= staffRect.bottom) {
          const direction = mouseY < staffRect.top + staffRect.height / 2 ? 'up' : 'down';
          this.note.stepMoveNote(direction);
        }
      }
    }

    const musicApp = new AppClass();
    musicApp.staff.drawStaff();
  });
</script>

</body>
</html>
