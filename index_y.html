<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #staff {
      position: relative;
      height: 200px;
      width: 100%;
      background-color: #f0f0f0;
      overflow: hidden;
    }

    .line {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background-color: black;
    }

    #note {
      position: absolute;
      height: 20px;
      width: 20px;
      background-color: black;
      border-radius: 50%;
      cursor: pointer;
      left: 100px;
      transition: top 0.2s ease;
    }
  </style>
  <title>Music App</title>
</head>
<body>

<!-- 五線譜と音符を表示するための要素 -->
<div id="staff"></div>
<div id="note"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {

    // 五線譜を管理するクラス
    class StaffClass {
      constructor() {
        this.staffElement = document.getElementById('staff');
        this.lines = [];
      }

      // 五線譜を描画するメソッド
      drawStaff() {
        for (let i = 0; i < 5; i++) {
          const line = document.createElement('div');
          line.className = 'line';
          line.style.top = `${40 + i * 20}px`;
          this.staffElement.appendChild(line);
          this.lines.push(40 + i * 20);
        }

        // 下の制限線を追加
        const lowerLimitLine = document.createElement('div');
        lowerLimitLine.className = 'line';
        lowerLimitLine.style.top = `${40 + 5 * 20}px`;
        lowerLimitLine.style.backgroundColor = 'transparent';
        this.staffElement.appendChild(lowerLimitLine);
      }
    }

    // 音符を管理するクラス
    class NoteClass {
      constructor(position, lines) {
        this.noteElement = document.getElementById('note');
        if (!this.noteElement) {
          throw new Error("Element with id 'note' not found");
        }
        this.lines = lines;
        this.setPosition(position);
      }

      // 音符の位置を設定するメソッド
      setPosition(position) {
        this.position = position;
        this.noteElement.style.top = `${position}px`;
      }

      // カーソルに応じて音符を移動するメソッド
      moveNote(direction) {
        const step = 20;
        const minPosition = 40;
        const maxPosition = 40 + 5 * 20;

        console.log("ok");

        if (direction === 'up' && this.position > minPosition) {
          console.log("up");
          for (let i = 0; i < this.lines.length; i++) {
            if (this.position <= this.lines[i]) {
              this.position = this.lines[i];
              break;
            }
          }
        } else if (direction === 'down' && this.position < maxPosition) {
          console.log("down");
          for (let i = this.lines.length - 1; i >= 0; i--) {
            if (this.position + step >= this.lines[i]) {
              this.position = this.lines[i] - step;
              break;
            }
          }
        }
        this.setPosition(this.position);
      }

      // カーソルに応じて音符をステップごとに移動するメソッド
      stepMoveNote(direction) {
        const currentLineIndex = this.lines.findIndex(line => this.position <= line + 10 && this.position >= line - 10);

        if (direction === 'up' && currentLineIndex > 0) {
          this.position = this.lines[currentLineIndex - 1];
        } else if (direction === 'down' && currentLineIndex < this.lines.length - 1) {
          this.position = this.lines[currentLineIndex + 1] - 20;
        }

        this.setPosition(this.position);
      }
    }

    // アプリケーション全体を管理するクラス
    class AppClass {
      constructor() {
        // 五線譜と音符のクラスのインスタンスを生成
        this.staff = new StaffClass();
        this.note = new NoteClass(100, this.staff.lines);
        // イベントのバインドと初期描画を実行
        this.bindEvents();
      }

      // マウス移動イベントのバインド
      bindEvents() {
        document.addEventListener('mousemove', (event) => this.handleCursorMovement(event));
      }

      // カーソル移動に応じて音符を移動させるメソッド
      handleCursorMovement(event) {
        const mouseY = event.clientY;
        const staffRect = this.staff.staffElement.getBoundingClientRect();

        // カーソル位置が五線譜内にある場合に音符を移動
        if (mouseY >= staffRect.top && mouseY <= staffRect.bottom) {
          // カーソル位置が中央より上なら上に、下なら下に移動
          const direction = mouseY < staffRect.top + staffRect.height / 2 ? 'up' : 'down';
          this.note.stepMoveNote(direction);
        }
      }
    }

    // アプリケーションの起動
    const musicApp = new AppClass();
    // 五線譜の初期描画
    musicApp.staff.drawStaff();
  });
</script>

</body>
</html>
